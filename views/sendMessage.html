<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>会议通知</title>
	<script type="text/javascript" src="/xt/msgnotification/static/js/vue.js"></script>
	<script src="/xt/msgnotification/static/js/jquery.min.js"></script>
	<link rel="stylesheet" href="/xt/msgnotification/static/dist/styles/iview.css">
	<script src="/xt/msgnotification/static/dist/iview.min.js"></script>
	<script src="/xt/msgnotification/static/iconfont/iconfont.js"></script>
</head>
<style>
* {
	margin: 0;
	padding: 0;
}
textarea{
	resize: none;
}
.ivu-input:focus {
	border-color: lightgray;
	outline: 0;

	box-shadow: none;
}
.正常{
	color: green
}
.已失效{
	color: red
}
.已发送{
	color: green
}
.发送失败{
	color: red
}
.发送中{
	color: #2d8cf0
	}weifasong
	.ivu-form .ivu-form-item-label{
		font-size: 14px;
	}
	td .ivu-input{
		border: none;
		background: none;
	}
	.ivu-input:hover {
		border-color: lightgray;
	}

	[v-cloak] {
		display: none;
	}

</style>
<body>
	<div v-cloak id="app">
		<header>
			
		</header>
		<template >
			<br><br>
			<row v-show="!show">
				<i-col style="width: 160px;display: inline-block;float: left;">
					<i-menu @on-select="menuselect" theme="light" active-name="post" width=80>
						<menu-item name="post">
							发送短信
						</menu-item>
						
						<menu-item name="postlist">
							发送记录
						</menu-item>
						<menu-item name="editending">
							短信结尾
						</menu-item>
						<menu-item name="contacts">
							常用联系人
						</menu-item>
					</i-menu>
				</i-col>
				<i-col span=20>
					<row v-show="postshow">
						<i-form  :model="formItem"   :label-width="100">
							<form-item label="手机号码:" prop="tel">
								<checkbox-group v-model="checkAllGroup" @on-change="checkAllGroupChange">
									<checkbox v-for="item in contactData" :key="item.Id" :label="item.Tel">{{item.Name}} ({{item.Tel}})</checkbox>
								</checkbox-group>
								<i-input v-model="formItem.tel" @on-change="telinputchange" type="textarea" :autosize="{minRows: 5}" placeholder="请输入手机号以英文符号“;”分割"></i-input>
							</form-item>
							<form-item label="发送内容:" prop="content">
								<i-input  v-model="formItem.content" type="textarea" :autosize="{minRows: 5}" placeholder="请输入信息内容"></i-input>
							</form-item>
							<form-item label="短信结尾:">
								<textarea readonly wrap="soft" autocomplete="off" spellcheck="false" placeholder="请设置短信结尾" style="color: gray" rows="5" v-model="ending" class="ivu-input"></textarea>
							</form-item>
							<form-item>
								<i-button style="margin-left: 8px;float: right;" @click="checkout" type="primary" >发送</i-button>
								<i-button @click="clear" style="margin-left: 8px;float: right;" >清空</i-button>
							</form-item>
						</i-form>
					</row>
					<row v-show="postlistshow" style="margin-left: 10px">
						<row style="float: right;margin: 10px">
							<date-picker v-model="serachtime" type="datetimerange" format="yyyy-MM-dd" placeholder="选择发送时间" @on-clear="searchTimeClear" @on-change="search" :editable="false" style="width: 180px"></date-picker>
							<i-select @on-change="search" v-model="searchname" clearable placeholder="请选择发送人" style="width:120px">
								<i-option v-for="item in namelist" :value="item.Name" :key="item.Name">{{ item.Name }}</i-option>
							</i-select>						
							<i-input v-model="searchtel" placeholder="输入接收手机号" style="width: 100px" /></i-input>
							<i-button @click="search" type="primary" style="margin-left: 8px;float: right;" >搜索</i-button>
							<i-button @click="clearsearch" style="margin-left: 8px;float: right;" >清空</i-button>
							
						</row>
						<br>
						<br>
						<br>
						<i-table  @on-row-click="rowclick" :columns="columns" :data="tabledata"></i-table>
						<br>
						<Row style="text-align: center;">
							<Page  :current.sync="page" @on-change="pageChange" @on-page-size-change="pageSizeChange" :total="totalcount" size="small" show-total show-elevator show-sizer></Page>
							<br>
							<br>
						</Row>

					</row>
					<row v-show="contactsshow" style="margin-left: 10px">
						<row style="float: right;margin: 10px">
							<i-button @click="addcontactmodel=true" type="primary" style="margin-left: 8px;float: right;" >添加</i-button>
						</row>
						<br>
						<br>
						<br>
						<i-table border  stripe :columns="coumnsContacts" :data="contactData"></i-table>

					</row>
					<row v-show="editendingshow">
						<i-form :label-width="100">
							<form-item label="短信结尾:">
								<i-input  :rows="5" v-model="ending" type="textarea"  placeholder="请设置短信结尾"></i-input>
							</form-item>
							<form-item>
								<i-button style="margin-left: 8px;float: right;" @click="endingclick" type="primary">确认</i-button>
							</form-item>
						</i-form>
					</row>
				</i-col>
			</row>
			<row v-show="show" style="text-align: center;margin: 200px;font-size: 24px">
				对不起权限受限，请联系管理员
			</row>
		</template>
		<Modal v-model="resendModel" width="360">
			<p slot="header" style="color:#f60;text-align:left">
				<Icon type="information-circled"></Icon>
				<span>提示</span>
			</p>
			<div style="text-align:left">
				<p>确认重新发送吗</p>
			</div>
			<div slot="footer">
				<i-button size="large" @click="resendModel = false">取消</i-button>
				<i-button type="primary" size="large" @click="resendMessage();resendModel=false">确认</i-button>
			</div>
		</Modal>
		<Modal  v-model="confirmmodel" title="确认手机号及发送内容" @on-ok="confirmSend" @on-cancel="confirmmodel=false">
			<i-form  :model="formItem"   :label-width="80">
				<form-item label="手机号码:" prop="tel">
					<i-input readonly v-model="formItem.tel" type="textarea" :autosize="{minRows: 5}" placeholder="请输入手机号以英文符号“;”分割"></i-input>
				</form-item>
				<form-item  label="发送内容:" prop="content">
					<i-input readonly v-model="formItem.content" type="textarea" :autosize="{minRows: 5}" placeholder="请输入信息内容"></i-input>
				</form-item>
			</i-form>
		</Modal>
		<Modal  v-model="addcontactmodel" title="添加联系人" >
			<i-form  :model="contactFormItem"   :label-width="80">
				<form-item label="姓名:" >
					<i-input v-model="contactFormItem.name" placeholder="请输入姓名"></i-input>
				</form-item>
				<form-item label="电话号:" >
					<i-input v-model="contactFormItem.tel" placeholder="请输入电话号"></i-input>
				</form-item>
				
			</i-form>
			<div slot="footer" style="height: 35px"> 
				<i-button style="margin-left: 8px;float: right;" @click="confirmaddcontact" type="primary">确认</i-button>
				<i-button style="margin-left: 8px;float: right;" @click="addcontactmodel=false">取消</i-button>
				
			</div>
		</Modal>
		<Modal  v-model="editcontactmodel" title="编辑联系人">
			<i-form  :model="editcontactFormItem"   :label-width="80">
				<form-item label="姓名:" >
					<i-input v-model="editcontactFormItem.Name" placeholder="请输入姓名"></i-input>
				</form-item>
				<form-item label="电话号:" >
					<i-input v-model="editcontactFormItem.Tel" placeholder="请输入电话号"></i-input>
				</form-item>
				<form-item label="状态:" >
					<i-select v-model="editcontactFormItem.Status">
						<i-option value="1">正常</i-option>
						<i-option value="-1">已失效</i-option>
					</i-select>
				</form-item>
				
			</i-form>
			<div slot="footer" style="height: 35px">
				<i-button style="margin-left: 8px;float: right;" @click="confirmeditcontact" type="primary">确认</i-button>
				<i-button style="margin-left: 8px;float: right;" @click="editcontactmodel=false" >取消</i-button>
				
			</div>
		</Modal>
		<Modal v-model="dialogAlert" width="360">
			<p slot="header" style="color:#f60;text-align:left">
				<Icon type="information-circled"></Icon>
				<span>提示</span>
			</p>
			<div style="text-align:left">
				<p>{{alertMsg}}</p>
			</div>
			<div slot="footer">
				<i-button type="primary" size="large" @click="dialogAlert = false">确认</i-button>
			</div>
		</Modal>
	</div>
</body>
<script>
	Date.prototype.format=function(format){var o={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),"S":this.getMilliseconds()};if(/(y+)/.test(format)){format=format.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))}for(var k in o){if(new RegExp("("+k+")").test(format)){format=format.replace(RegExp.$1,RegExp.$1.length==1?o[k]:("00"+o[k]).substr((""+o[k]).length))}}return format};
	var app = new Vue({
		el: '#app',
		data: {
			show:false,
			namelist:[],
			contactData:[],
			editcontactmodel:false,
			addcontactmodel:false,
			resendModel:false,
			resendData:{},
			ftime:"",
			ltime:"",
			serachtime:"",
			searchname:'',
			searchtel:"",
			ending:<<<.ending>>>,
			postshow:true,
			postlistshow:false,
			editendingshow:false,
			contactsshow:false,
			dialogAlert:false,
			alertMsg:'',
			modalType:1,
			confirmmodel:false,
			modalPlaceholder:'',
			modalInput:'',
			group:[],
			detailTableData:[],
			checkAllGroup:[],
			formItem:{
				'content':"",
				'tel':"",

			},
			editcontactFormItem:{
				'Name':"",
				'Tel':"",
				'Status':"",
				'Id':0
			},
			contactFormItem:{
				'name':"",
				'tel':"",

			},
			coumnsContacts:[
			{
				align:'center',
				title: '姓名',
				key: 'Name',
				render:function (h, params) {
					return h('span', {
					},app.getName(params.row.Name))
				}

			},
			{
				align:'center',
				title: '电话号',
				key: 'Tel',
				

			},
			{
				align:'center',
				title: '状态',
				key: 'Status',
				render:function (h, params) {
					return h('span', {
						class:app.getContactStatus(params.row.Status)
					},app.getContactStatus(params.row.Status))
				}

			},
			{
				align:'center',
				title: '操作',
				key: 'Tel',
				render:function (h, params) {
					return h('i-button', {
						
						props:{
							type:"primary",
						},
						on:{
							click:function(){
								app.editcontactFormItem.Id = params.row.Id
								app.editcontactFormItem.Name = params.row.Name
								app.editcontactFormItem.Tel =params.row.Tel
								app.editcontactFormItem.Status = ""+params.row.Status
								app.editcontactmodel=true


							}
						}
					},"编辑")
				}
			},
			],
			coumnsdetail:[
			{
				align:'center',
				title: '姓名',
				key: 'Name',
				render:function (h, params) {
					return h('span', {
					},app.getName(params.row.Name))
				}

				

			},

			{
				align:'center',
				title: '电话号',
				key: 'Tel',
				

			},
			{
				align:'center',
				title: '状态',
				key: 'Status',
				render:function (h, params) {
					return h('span', {
						class:app.getSStatus(params.row.Status)
					},app.getSStatus(params.row.Status))
				}
				
			},
			{
				align:'center',
				title: '操作',
				width:160,
				render:function (h, params) {
					return h('i-button', {
						
						props:{
							type:"primary",
							disabled:app.getResendDisabled(params.row.Status)
						},
						on:{
							click:function(){
								app.resendData = params
								app.resendModel=true

							}
						}
					},"重发")
				}
			}
			],
			columns: [
			{
				type: 'expand',
				width: 20,
				render: function (h, params) {
					return h("i-table", {
						props:{
							columns:app.coumnsdetail,
							data:app.handleDataForIndex(params.row),
							border:false
						}
					})
				}
			},
			{
				align:'center',
				title: '发送人',
				key: 'Name',
				width:80,

			},
			{
				align:'center',
				title: '发送时间',
				key: 'Date',
				width:100,
			},
			{
				align:'center',
				title: '接收手机号码',
				key: 'Tel',
				width:196

			},
			{
				align:'center',
				title: '发送内容',
				key: 'Content',
				minwidth:200,
				render:function (h, params) {
					return h('i-input', {
						props:{
							value:params.row.Content,
							type:"textarea",
							readonly:true,
							autosize:true,
						},
					})
				}

			},
			{
				align:'center',
				title: '短信结尾',
				key: 'Ending',
				width:200,
				render:function (h, params) {
					return h('i-input', {
						props:{
							value:params.row.Ending,
							type:"textarea",
							readonly:true,
							autosize:true,
						},
						
					})
				}

			},
			{
				align:'center',
				title: '状态',
				width:85,
				key: 'Status',
				render:function (h, params) {
					return h('span', {
						class:app.getSStatus(params.row.Status)
					},app.getSStatus(params.row.Status))
				}

			}
			],
			username:'',
			tabledata:[],
			totalcount:0,
			limit:10,
			page:1,


		},
		created:function(){
			this.loadData();
			this.loadContacts(1);
		},
		methods: {
			getName:function (name) {
				if (name) {
					return name
				}
				return "-"
			},
			mytrim:function (str){ 
				return str.replace(/(^;*)|(;*$)/g,""); 
			},
			telinputchange:function () {
				this.formItem.tel=this.formItem.tel.trim()
				this.formItem.tel=this.formItem.tel.replace("；",";")
				this.formItem.tel=this.mytrim(this.formItem.tel)
				var oldtelarr = this.formItem.tel.split(";")

				this.checkAllGroup=oldtelarr
			},
			checkAllGroupChange:function () {
				this.formItem.Tel = this.mytrim(this.checkAllGroup.join(";")).trim()
				Vue.set(this.formItem, "tel", this.formItem.Tel);
			},

			handleDataForIndex:function(data){
				for (var i = 0; i < data.Telnumber.length; i++) {
					data.Telnumber[i].pindex=data._index
				}
				return data.Telnumber
			},
			resendMessage:function(){
				var _this=this
				$.ajax({
					url: "/xt/msgnotification/resendmessage",
					type: 'post',
					dataType: "json",
					data: {
						id:_this.resendData.row.Id
					},
					async: true,
					success: function(data) {
						if(data.success) {
							tabledatai = _this.tabledata[params.row.pindex]
							tabledatai.Status=data.data.FStatus
							tabledatai.Telnumber[params.row._index].Status=data.data.SStatus
							_this.dialogAlert = true;
							_this.alertMsg = data.errmsg
						}else{
							_this.dialogAlert = true;
							_this.alertMsg = data.errmsg;
						}
					},
					error: function() {
						_this.dialogAlert = true;
						_this.alertMsg = '错误，请稍后再试！';
					}
				});
			},
			rowclick:function (data,index) {
				data._expanded=!data._expanded
				Vue.set(this.tabledata, index, data);

			},
			clearsearch:function () {
				this.ftime=""
				this.ltime=""
				this.searchtel=""
				this.searchname=""
				this.serachtime=""
				this.page=1
				this.loadList()	
			},
			search:function () {	
				if (this.serachtime[0]) {
					this.ftime = this.serachtime[0].format("yyyy-MM-dd hh:mm:ss")
					this.ltime = this.serachtime[1].format("yyyy-MM-dd hh:mm:ss")
				}
				this.page=1
				this.loadList()

			},
			searchTimeClear:function () {
				this.ftime=""
				this.ltime=""
				this.search	
			},
			getContactStatus:function (status) {
				switch(status) {
					case 1:
					return "正常"
					break;
					case -1:
					return "已失效"
				}

			},
			getSStatus:function (status) {
				switch(status) {
					case 0:
					return "发送中"
					break;
					case 1:
					return "已发送"
					break;
					case -1:
					return "发送失败"
					break;
				}
			},
			getResendDisabled:function (status) {

				if (status==-1) {
					return false
				}
				return true

			},
			clear:function () {
				this.formItem={ 'content':"",'tel':"",}
			},
			iGetInnerText:function (testStr) {
				var resultStr = testStr.replace(/\ +/g, ""); 
				resultStr = testStr.replace(/[ ]/g, "");    
				resultStr = testStr.replace(/[\r\n]/g, ""); 
				return resultStr;
			},

			ValidatePhone:function (val){
				var isPhone =  /^((1[3,5,8][0-9])|(14[5,7])|(17[0,6,7,8])|(19[7]))\d{8}$/;

				if(isPhone.test(val)){
					return true;
				}
				else{
					return false;
				}
			},	
			checkout:function () {
				if (!this.formItem.tel) {
					this.dialogAlert=true
					this.alertMsg="请输入手机号"
					return
				}
				this.formItem.tel = this.iGetInnerText(this.formItem.tel)

				var telArrOld = this.formItem.tel.split(';');
				var telArrNew=new Array()
				for (var i = 0; i < telArrOld.length; i++) {
					if (telArrOld[i]!="") {
						if (!this.ValidatePhone(telArrOld[i])) {
							this.dialogAlert=true
							this.alertMsg="手机号填写错误错误号码为: "+telArrOld[i]
							return
						}else{
							if(telArrNew.indexOf(telArrOld[i])!=-1){
								break
							}else{
								telArrNew.push(telArrOld[i])		
							}
						}
					}

				}
				this.formItem.tel=telArrNew.join(";")
				this.checkAllGroup = telArrNew
				if (this.formItem.content=="") {
					this.dialogAlert=true
					this.alertMsg="请输入信息内容"
					return
				}
				this.confirmmodel=true

			},		
			confirmaddcontact:function () {
				if (!this.contactFormItem.tel) {
					this.dialogAlert=true
					this.alertMsg="请输入手机号"
					return
				}
				if (!this.ValidatePhone(this.contactFormItem.tel)) {
					this.dialogAlert=true
					this.alertMsg="请输入正确的手机号"
					return
				}
				var _this=this
				$.ajax({
					url: "/xt/msgnotification/addcontact",
					type: 'post',
					dataType: "json",
					data: {
						name:this.contactFormItem.name,
						tel:this.contactFormItem.tel
					},
					async: true,
					success: function(data) {
						if(data.success) {
							_this.addcontactmodel=false
							_this.dialogAlert = true;
							_this.alertMsg = "添加成功"
							_this.contactFormItem={
								'name':"",
								'tel':"",

							}

						}else{
							_this.dialogAlert = true;
							_this.alertMsg = data.errmsg;
						}
						_this.loadContacts(0)

					},
					error: function() {

						_this.dialogAlert = true;
						_this.alertMsg = '错误，请稍后再试！';
					}
				});
			},
			confirmeditcontact:function () {
				if (!this.editcontactFormItem.Tel) {
					this.dialogAlert=true
					this.alertMsg="请输入手机号"

					return true;
				}
				if (!this.ValidatePhone(this.editcontactFormItem.Tel)) {
					this.dialogAlert=true
					this.alertMsg="请输入正确的手机号"
					return false;
				}
				var _this=this
				$.ajax({
					url: "/xt/msgnotification/updatecontact",
					type: 'post',
					dataType: "json",
					data: {
						id :this.editcontactFormItem.Id,
						name:this.editcontactFormItem.Name,
						tel:this.editcontactFormItem.Tel,
						status:parseInt(this.editcontactFormItem.Status)
					},
					async: true,
					success: function(data) {
						if(data.success) {
							_this.editcontactmodel=false
							_this.dialogAlert=true
							_this.alertMsg = "修改成功"
						}else{
							_this.dialogAlert = true;
							_this.alertMsg = data.errmsg;
						}
						_this.loadContacts(0)

					},
					error: function() {
						_this.dialogAlert = true;
						_this.alertMsg = '错误，请稍后再试！';
					}
				});
			},
			confirmSend:function () {
				var _this=this
				$.ajax({
					url: "/xt/msgnotification/postmessage",
					type: 'post',
					dataType: "json",
					data: {
						name:this.username,
						ending:this.ending,
						content:this.formItem.content,
						tel:this.formItem.tel
					},
					async: true,
					success: function(data) {
						if(data.success) {
							_this.dialogAlert = true;
							_this.alertMsg = data.errmsg
						}else{
							_this.dialogAlert = true;
							_this.alertMsg = data.errmsg;
						}
						_this.page=1
						_this.loadList()

					},
					error: function() {
						_this.page=1
						_this.loadList()
						_this.dialogAlert = true;
						_this.alertMsg = '错误，请稍后再试！';
					}
				});
			},
			endingclick:function () {
				var _this=this
				$.ajax({
					url: "/xt/msgnotification/setparam",
					type: 'post',
					dataType: "json",
					data: {
						key:"ending",
						value:_this.ending
					},
					async: true,
					success: function(data) {
						if(data.success) {
							_this.dialogAlert = true;
							_this.alertMsg = "设置成功";
						}else{
							_this.dialogAlert = true;
							_this.alertMsg = data.errmsg;
						}
					},
					error: function() {
						_this.dialogAlert = true;
						_this.alertMsg = '错误，请稍后再试！';
					}
				});
			},
			pageChange:function (page) {
				this.page=page;
				this.loadList()
			},
			pageSizeChange:function (pageSize) {
				this.limit=pageSize
				this.loadList()
			},
			menuselect:function (name) {
				switch(name) {
					case "post":
					this.loadContacts(1);
					this.postshow=true;
					this.postlistshow=false;
					this.editendingshow=false;
					this.contactsshow=false;
					break;
					case "postlist":
					this.loadList();
					this.postshow=false;
					this.postlistshow=true;
					this.contactsshow=false;
					this.editendingshow=false;
					break;
					case "editending":
					this.postshow=false;
					this.contactsshow=false;
					this.postlistshow=false;
					this.editendingshow=true;
					break;
					case "contacts":
					this.loadContacts(0);
					this.contactsshow=true
					this.postshow=false;
					this.postlistshow=false;
					this.editendingshow=false;
					break;
				}
			},
			loadContacts:function (status) {
				var _this=this
				$.ajax({
					url: "/xt/msgnotification/getcontacts",
					type: 'post',
					dataType: "json",
					data: {
						status:status
					},
					async: true,
					success: function(data) {
						if(data.success) {
							_this.contactData=data.data
						}else{
							_this.dialogAlert = true;
							_this.alertMsg = data.errmsg;
						}
					},
					error: function() {
						_this.dialogAlert = true;
						_this.alertMsg = '错误，请稍后再试！';
					}
				});
			},
			loadList:function () {
				var _this=this
				$.ajax({
					url: "/xt/msgnotification/getmessage",
					type: 'post',
					dataType: "json",
					data: {
						limit:_this.limit,
						page:_this.page,
						name:_this.searchname,
						ftime:_this.ftime,
						ltime:_this.ltime,
						tel:_this.searchtel
					},
					async: true,
					success: function(data) {
						if(data.success) {
							_this.totalcount=data.total
							_this.tabledata=data.data
						}else{
							_this.dialogAlert = true;
							_this.alertMsg = data.errmsg;
						}
					},
					error: function() {
						_this.dialogAlert = true;
						_this.alertMsg = '错误，请稍后再试！';
					}
				});
			},
			loadData:function () {
				var _this=this
				$.ajax({
					url: "/xt/msgnotification/getuser",
					type: 'post',
					dataType: "json",
					data: {
						rtxaccount:<<<.rtxaccount>>>
					},
					async: true,
					success: function(data) {
						if(data.success) {
							_this.namelist=data.data.NameArr
							_this.username=data.data.Name
							_this.show=false
						}else{
							_this.show=true
						}
					},
					error: function() {
						_this.dialogAlert = true;
						_this.alertMsg = '错误，请稍后再试！';
					}
				});


			},

		}
	})

</script>
</html>