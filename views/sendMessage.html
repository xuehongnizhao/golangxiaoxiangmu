<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>会议通知</title>
	<script type="text/javascript" src="/msgnotification/static/js/vue.js"></script>
	<script src="/msgnotification/static/js/jquery.min.js"></script>
	<link rel="stylesheet" href="/msgnotification/static/dist/styles/iview.css">
	<script src="/msgnotification/static/dist/iview.min.js"></script>
	<script src="/msgnotification/static/iconfont/iconfont.js"></script>
</head>
<style>
* {
	margin: 0;
	padding: 0;
}
textarea{
	resize: none;
}
.ivu-input:focus {
	border-color: lightgray;
	outline: 0;

	box-shadow: none;
}

.发送成功{
	color: green
}
.发送失败{
	color: red
}
.发送中{
	color: #2d8cf0
}
.ivu-form .ivu-form-item-label{
	font-size: 14px;
}
td .ivu-input{
	border: none;
	background: none;
}
.ivu-input:hover {
	border-color: lightgray;
}

[v-cloak] {
	display: none;
}

</style>
<body>
	<div v-cloak id="app">
		<header>
			
		</header>
		<template >
			<br><br>
			<row v-show="!show">
				<i-col style="width: 160px;display: inline-block;float: left;">
					<i-menu @on-select="menuselect" theme="light" active-name="post" width=80>
						<menu-item name="post">
							发送短信
						</menu-item>
						<menu-item name="postlist">
							发送记录
						</menu-item>
						<menu-item name="editending">
							短信结尾
						</menu-item>
					</i-menu>
				</i-col>
				<i-col span=21>
					<row v-show="postshow">
						<i-form  :model="formItem"   :label-width="100">
							<form-item label="手机号码:" prop="tel">
								<i-input v-model="formItem.tel" type="textarea" :autosize="{minRows: 5}" placeholder="请输入手机号以英文符号“;”分割"></i-input>
							</form-item>
							<form-item label="发送内容:" prop="content">
								<i-input  v-model="formItem.content" type="textarea" :autosize="{minRows: 5}" placeholder="请输入信息内容"></i-input>
							</form-item>
							<form-item label="短信结尾:">
								<textarea readonly wrap="soft" autocomplete="off" spellcheck="false" placeholder="请设置短信结尾" style="color: gray" rows="5" v-model="ending" class="ivu-input"></textarea>
							</form-item>
							<form-item>
								<i-button style="margin-left: 8px;float: right;" @click="checkout" type="primary" >发送</i-button>
								<i-button @click="clear" style="margin-left: 8px;float: right;" >清空</i-button>
							</form-item>
						</i-form>
					</row>
					<row v-show="postlistshow" style="margin-left: 10px">
						<row style="float: right;margin: 10px">
							<date-picker v-model="serachtime" type="datetimerange" format="yyyy-MM-dd HH:mm" placeholder="选择时间" :editable="false" style="width: 250px"></date-picker>
							<i-input v-model="searchname" placeholder="输入发送人" style="width: 200px" /></i-input>
							<i-input v-model="searchtel" placeholder="输入接收手机号" style="width: 200px" /></i-input>
							<i-button @click="search" type="primary" style="margin-left: 8px;float: right;" >搜索</i-button>
							<i-button @click="clearsearch" style="margin-left: 8px;float: right;" >清空</i-button>
							
						</row>
						<br>
						<br>
						<br>
						<i-table  :columns="columns" :data="tabledata"></i-table>
						<br>
						<Row style="text-align: center;">
							<Page  @on-change="pageChange" @on-page-size-change="pageSizeChange" :total="totalcount" size="small" show-total show-elevator show-sizer></Page>
							<br>
							<br>
						</Row>

					</row>
					<row v-show="editendingshow">
						<i-form :label-width="100">
							<form-item label="短信结尾:">
								<i-input  :rows="5" v-model="ending" type="textarea"  placeholder="请设置短信结尾"></i-input>
							</form-item>
							<form-item>
								<i-button style="margin-left: 8px;float: right;" @click="endingclick" type="primary">确认</i-button>
							</form-item>
						</i-form>

					</row>
				</i-col>
			</row>
			<row v-show="show" style="text-align: center;margin: 200px;font-size: 24px">
				对不起权限受限，请联系管理员
			</row>
		</template>
		<Modal  v-model="confirmmodel" title="确认手机号及发送内容" @on-ok="confirmSend" @on-cancel="confirmmodel=false">
			<i-form  :model="formItem"   :label-width="80">
				<form-item label="手机号码:" prop="tel">
					<i-input readonly v-model="formItem.tel" type="textarea" :autosize="{minRows: 5}" placeholder="请输入手机号以英文符号“;”分割"></i-input>
				</form-item>
				<form-item  label="发送内容:" prop="content">
					<i-input readonly v-model="formItem.content" type="textarea" :autosize="{minRows: 5}" placeholder="请输入信息内容"></i-input>
				</form-item>
			</i-form>
		</Modal>
		<Modal v-model="dialogAlert" width="360">
			<p slot="header" style="color:#f60;text-align:left">
				<Icon type="information-circled"></Icon>
				<span>提示</span>
			</p>
			<div style="text-align:left">
				<p>{{alertMsg}}</p>
			</div>
			<div slot="footer">
				<i-button type="primary" size="large" @click="dialogAlert = false">确认</i-button>
			</div>
		</Modal>
	</div>
</body>
<script>
	Date.prototype.format=function(format){var o={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),"S":this.getMilliseconds()};if(/(y+)/.test(format)){format=format.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))}for(var k in o){if(new RegExp("("+k+")").test(format)){format=format.replace(RegExp.$1,RegExp.$1.length==1?o[k]:("00"+o[k]).substr((""+o[k]).length))}}return format};
	var app = new Vue({
		el: '#app',
		data: {
			show:false,
			ftime:"",
			ltime:"",
			serachtime:"",
			searchname:'',
			searchtel:"",
			ending:<<<.ending>>>,
			postshow:true,
			postlistshow:false,
			editendingshow:false,
			dialogAlert:false,
			alertMsg:'',
			modalType:1,
			confirmmodel:false,
			modalPlaceholder:'',
			modalInput:'',
			group:[],
			detailTableData:[],

			formItem:{
				'content':"",
				'tel':"",

			},
			coumnsdetail:[
			{
				align:'center',
				title: '电话号',
				key: 'Tel',
				

			},
			{
				align:'center',
				title: '状态',
				key: 'Status',
				render:function (h, params) {
					return h('span', {
						class:app.getSStatus(params.row.Status)
					},app.getSStatus(params.row.Status))
				}
				
			},
			{
				align:'center',
				title: '操作',
				width:160,
				render:function (h, params) {
					return h('i-button', {
						
						props:{
							type:"primary",
							disabled:app.getResendDisabled(params.row.Status)
						}
					},"重发")
				}
			}
			],
			columns: [
			{
				type: 'expand',
				width: 50,
				render: function (h, params) {
					return h("i-table", {
						props:{
							columns:app.coumnsdetail,
							data:params.row.Telnumber,
							border:false
						}
					})
				}
			},
			{
				align:'center',
				title: '发送人',
				key: 'Name',
				width:80,

			},
			{
				align:'center',
				title: '发送时间',
				key: 'Date',
				width:160,
			},
			{
				align:'center',
				title: '接收手机号码',
				key: 'Tel',
				width:115

			},
			{
				align:'center',
				title: '发送内容',
				key: 'Content',
				render:function (h, params) {
					return h('i-input', {
						props:{
							value:params.row.Content,
							type:"textarea",
							readonly:true,
							autosize:true,
						},
					})
				}

			},
			{
				align:'center',
				title: '短信结尾',
				key: 'Ending',
				width:200,
				render:function (h, params) {
					return h('i-input', {
						props:{
							value:params.row.Ending,
							type:"textarea",
							readonly:true,
							autosize:true,
						},
						
					})
				}

			},
			{
				align:'center',
				title: '状态',
				width:160,
				key: 'Status',
				render:function (h, params) {
					return h('span', {
						class:app.getSStatus(params.row.Status)
					},app.getSStatus(params.row.Status))
				}

			}
			],
			username:'',
			tabledata:[],
			totalcount:0,
			limit:10,
			page:1,


		},
		created:function(){
			this.loadData();
		},
		methods: {
			clearsearch:function () {
				this.ftime=""
				this.ltime=""
				this.searchtel=""
				this.searchname=""
				this.serachtime=""
				this.loadList()	
			},
			search:function () {	
				if (this.serachtime[0]) {
					this.ftime = this.serachtime[0].format("yyyy-MM-dd hh:mm:ss")
					this.ltime = this.serachtime[1].format("yyyy-MM-dd hh:mm:ss")
				}
				if (!this.ValidatePhone(this.searchtel)&&this.searchtel) {
					this.dialogAlert=true
					this.alertMsg="请输入正确的手机号"
					return
				}
				this.loadList()
				
			},
			getSStatus:function (status) {
				switch(status) {
					case 0:
					return "发送中"
					break;
					case 1:
					return "发送成功"
					break;
					case -1:
					return "发送失败"
					break;
				}
			},
			getResendDisabled:function (status) {

				if (status==-1) {
					return false
				}
				return true
				
			},
			clear:function () {
				this.formItem={ 'content':"",'tel':"",}
			},
			iGetInnerText:function (testStr) {
				var resultStr = testStr.replace(/\ +/g, ""); 
				resultStr = testStr.replace(/[ ]/g, "");    
				resultStr = testStr.replace(/[\r\n]/g, ""); 
				return resultStr;
			},

			ValidatePhone:function (val){
				var isPhone =  /^((1[3,5,8][0-9])|(14[5,7])|(17[0,6,7,8])|(19[7]))\d{8}$/;

				if(isPhone.test(val)){
					return true;
				}
				else{
					return false;
				}
			},	
			checkout:function () {
				if (!this.formItem.tel) {
					this.dialogAlert=true
					this.alertMsg="请输入手机号"
					return
				}
				this.formItem.tel = this.iGetInnerText(this.formItem.tel)

				var telArrOld = this.formItem.tel.split(';');
				var telArrNew=new Array()
				for (var i = 0; i < telArrOld.length; i++) {
					if (telArrOld[i]!="") {
						if (!this.ValidatePhone(telArrOld[i])) {
							this.dialogAlert=true
							this.alertMsg="手机号填写错误错误号码为: "+telArrOld[i]
							return
						}else{
							telArrNew.push(telArrOld[i])	
						}
					}

				}
				this.formItem.tel=telArrNew.join(";")
				if (this.formItem.content=="") {
					this.dialogAlert=true
					this.alertMsg="请输入信息内容"
					return
				}
				this.confirmmodel=true

			},		
			confirmSend:function () {
				var _this=this
				$.ajax({
					url: "/msgnotification/postmessage",
					type: 'post',
					dataType: "json",
					data: {
						name:this.username,
						ending:this.ending,
						content:this.formItem.content,
						tel:this.formItem.tel
					},
					async: true,
					success: function(data) {
						if(data.success) {
							_this.dialogAlert = true;
							_this.alertMsg = "发送成功";
						}else{
							_this.dialogAlert = true;
							_this.alertMsg = data.errmsg;
						}
					},
					error: function() {
						_this.dialogAlert = true;
						_this.alertMsg = '错误，请稍后再试！';
					}
				});
			},
			endingclick:function () {
				var _this=this
				$.ajax({
					url: "/msgnotification/setparam",
					type: 'post',
					dataType: "json",
					data: {
						key:"ending",
						value:_this.ending
					},
					async: true,
					success: function(data) {
						if(data.success) {
							_this.dialogAlert = true;
							_this.alertMsg = "设置成功";
						}else{
							_this.dialogAlert = true;
							_this.alertMsg = data.errmsg;
						}
					},
					error: function() {
						_this.dialogAlert = true;
						_this.alertMsg = '错误，请稍后再试！';
					}
				});
			},
			pageChange:function (page) {
				this.page=page;
				this.loadList()
			},
			pageSizeChange:function (pageSize) {
				this.limit=pageSize
				this.loadList()
			},
			menuselect:function (name) {
				switch(name) {
					case "post":
					this.loadData();
					this.postshow=true;
					this.postlistshow=false;
					this.editendingshow=false;
					break;
					case "postlist":
					this.loadList();
					this.postshow=false;
					this.postlistshow=true;
					this.editendingshow=false;
					break;
					case "editending":
					this.postshow=false;
					this.postlistshow=false;
					this.editendingshow=true;
					break;
				}
			},
			loadList:function () {
				var _this=this
				$.ajax({
					url: "/msgnotification/getmessage",
					type: 'post',
					dataType: "json",
					data: {
						limit:_this.limit,
						page:_this.page,
						name:_this.searchname,
						ftime:_this.ftime,
						ltime:_this.ltime,
						tel:_this.searchtel
					},
					async: true,
					success: function(data) {
						if(data.success) {
							_this.totalcount=data.total
							_this.tabledata=data.data
						}else{
							_this.dialogAlert = true;
							_this.alertMsg = data.errmsg;
						}
					},
					error: function() {
						_this.dialogAlert = true;
						_this.alertMsg = '错误，请稍后再试！';
					}
				});
			},
			loadData:function () {
				var _this=this
				$.ajax({
					url: "/msgnotification/getuser",
					type: 'post',
					dataType: "json",
					data: {
						rtxaccount:<<<.rtxaccount>>>
					},
					async: true,
					success: function(data) {
						if(data.success) {
							_this.username=data.data[0].Name
							_this.show=false
						}else{
							_this.show=true
						}
					},
					error: function() {
						_this.dialogAlert = true;
						_this.alertMsg = '错误，请稍后再试！';
					}
				});
			},

		}
	})

</script>
</html>