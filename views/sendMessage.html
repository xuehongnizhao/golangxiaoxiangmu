<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>会议通知</title>
	<script type="text/javascript" src="/msgnotification/static/js/vue.js"></script>
	<script src="/msgnotification/static/js/jquery.min.js"></script>
	<link rel="stylesheet" href="/msgnotification/static/dist/styles/iview.css">
	<script src="/msgnotification/static/dist/iview.min.js"></script>
	<script src="/msgnotification/static/iconfont/iconfont.js"></script>
</head>
<style>
* {
	margin: 0;
	padding: 0;
}
textarea{
	resize: none;
}
.ivu-input:focus {
	border-color: lightgray;
	outline: 0;

	box-shadow: none;
}


.ivu-form .ivu-form-item-label{
	font-size: 14px;
}
td .ivu-input{
	border: none;
	background: none;
}
.ivu-input:hover {
	border-color: lightgray;
}

[v-cloak] {
	display: none;
}

</style>
<body>
	<div v-cloak id="app">
		<header>
			
		</header>
		<template >
			<br><br>
			<row v-show="!show">
				<i-col span=3>
					<i-menu @on-select="menuselect" theme="light" active-name="post" width=80>
						<menu-item name="post">
							发送短信
						</menu-item>
						<menu-item name="postlist">
							发送记录
						</menu-item>
						<menu-item name="editending">
							短信结尾
						</menu-item>
					</i-menu>
				</i-col>
				<i-col span=19>
					<row v-show="postshow">
						<i-form  :model="formItem"   :label-width="100">
							<form-item label="手  机 号:" prop="tel">
								<i-input v-model="formItem.tel" type="textarea" :autosize="{minRows: 5}" placeholder="请输入手机号以英文符号“;”分割"></i-input>
							</form-item>
							<form-item label="发送内容:" prop="content">
								<i-input  v-model="formItem.content" type="textarea" :autosize="{minRows: 5}" placeholder="请输入信息内容"></i-input>
							</form-item>
							<form-item label="短信结尾:">
								<textarea readonly wrap="soft" autocomplete="off" spellcheck="false" placeholder="请设置短信结尾" style="color: gray" rows="5" v-model="ending" class="ivu-input"></textarea>
							</form-item>
							<form-item>
								<i-button style="margin-left: 8px;float: right;" @click="checkout" type="primary" >发送</i-button>
								<i-button @click="clear" style="margin-left: 8px;float: right;" >清空</i-button>
							</form-item>
						</i-form>
					</row>
					<row v-show="postlistshow" style="margin-left: 10px">
						<i-table  :columns="columns" :data="tabledata"></i-table>
						<br>
						<Row style="text-align: center;">
							<Page  @on-change="pageChange" @on-page-size-change="pageSizeChange" :total="totalcount" size="small" show-total show-elevator show-sizer></Page>
						</Row>

					</row>
					<row v-show="editendingshow">
						<i-form :label-width="100">
							<form-item label="短信结尾">
								<i-input  :rows="5"  style.native="color: blue" v-model="ending" type="textarea"  placeholder="请设置短信结尾"></i-input>
							</form-item>
							<form-item>
								<i-button style="margin-left: 8px;float: right;" @click="endingclick" type="primary">确认</i-button>
							</form-item>
						</i-form>

					</row>
				</i-col>
			</row>
			<row v-show="show" style="text-align: center;margin: 200px;font-size: 24px">
				对不起权限受限，请联系管理员
			</row>
		</template>
		<Modal  v-model="confirmmodel" title="确认发送手机号及内容" @on-ok="confirmSend" @on-cancel="confirmmodel=false">
			<i-form  :model="formItem"   :label-width="80">
				<form-item label="手机号" prop="tel">
					<i-input readonly v-model="formItem.tel" type="textarea" :autosize="{minRows: 5}" placeholder="请输入手机号以英文符号“;”分割"></i-input>
				</form-item>
				<form-item  label="发送内容" prop="content">
					<i-input readonly v-model="formItem.content" type="textarea" :autosize="{minRows: 5}" placeholder="请输入信息内容"></i-input>
				</form-item>
			</i-form>
		</Modal>
		<Modal v-model="dialogAlert" width="360">
			<p slot="header" style="color:#f60;text-align:left">
				<Icon type="information-circled"></Icon>
				<span>提示</span>
			</p>
			<div style="text-align:left">
				<p>{{alertMsg}}</p>
			</div>
			<div slot="footer">
				<i-button type="primary" size="large" @click="dialogAlert = false">确认</i-button>
			</div>
		</Modal>
	</div>
</body>
<script>
	var app = new Vue({
		el: '#app',
		data: {
			show:false,
			ending:<<<.ending>>>,
			postshow:true,
			postlistshow:false,
			editendingshow:false,
			dialogAlert:false,
			alertMsg:'',
			modalType:1,
			confirmmodel:false,
			modalPlaceholder:'',
			modalInput:'',
			group:[],

			formItem:{
				'content':"",
				'tel':"",

			},
			columns: [
			{
				align:'center',
				title: '发送人',
				key: 'Name',
				width:80,

			},
			{
				align:'center',
				title: '发送时间',
				key: 'Date',
				width:160,
			},
			{
				align:'center',
				title: '接收手机号码',
				key: 'Tel',
				width:115

			},
			{
				align:'center',
				title: '发送内容',
				key: 'Content',
				render:function (h, params) {
					
					return h('i-input', {
						props:{
							value:params.row.Content,
							type:"textarea",
							readonly:true,
							autosize:true,
						},
					})
				}

			},
			{
				align:'center',
				title: '短信结尾',
				key: 'Ending',
				render:function (h, params) {
					
					return h('i-input', {
						props:{
							value:params.row.Ending,
							type:"textarea",
							readonly:true,
							autosize:true,
						},
						
					})
				}

			}
			],
			username:'',
			tabledata:[],
			totalcount:0,
			limit:10,
			page:1,


		},
		created:function(){
			this.loadData();
		},
		methods: {
			clear:function () {
				this.formItem={
				'content':"",
				'tel':"",}
			},
			iGetInnerText:function (testStr) {
				var resultStr = testStr.replace(/\ +/g, ""); 
				resultStr = testStr.replace(/[ ]/g, "");    
				resultStr = testStr.replace(/[\r\n]/g, ""); 
				return resultStr;
			},

			ValidatePhone:function (val){
				var isPhone =  /^((1[3,5,8][0-9])|(14[5,7])|(17[0,6,7,8])|(19[7]))\d{8}$/;

				if(isPhone.test(val)){
					return true;
				}
				else{
					return false;
				}
			},	
			checkout:function () {
				if (!this.formItem.tel) {
					this.dialogAlert=true
					this.alertMsg="请输入手机号"
					return
				}
				this.formItem.tel = this.iGetInnerText(this.formItem.tel)

				var telArr = this.formItem.tel.split(';');
				for (var i = 0; i < telArr.length; i++) {
					if (telArr[i]=="") {
						break
					}
					if (!this.ValidatePhone(telArr[i])) {
						this.dialogAlert=true
						this.alertMsg="手机号填写错误错误号码为: "+telArr[i]
						return
					}	
				}
				if (this.formItem.content=="") {
					this.dialogAlert=true
					this.alertMsg="请输入信息内容"
					return
				}
				this.confirmmodel=true
				
			},		
			confirmSend:function () {
				var _this=this
				$.ajax({
					url: "/msgnotification/postmessage",
					type: 'post',
					dataType: "json",
					data: {
						name:this.username,
						ending:this.ending,
						content:this.formItem.content,
						tel:this.formItem.tel
					},
					async: true,
					success: function(data) {
						if(data.success) {
							_this.dialogAlert = true;
							_this.alertMsg = "发送成功";
						}else{
							_this.dialogAlert = true;
							_this.alertMsg = data.errmsg;
						}
					},
					error: function() {
						_this.dialogAlert = true;
						_this.alertMsg = '错误，请稍后再试！';
					}
				});
			},
			endingclick:function () {
				var _this=this
				$.ajax({
					url: "/msgnotification/setparam",
					type: 'post',
					dataType: "json",
					data: {
						key:"ending",
						value:_this.ending
					},
					async: true,
					success: function(data) {
						if(data.success) {
							_this.dialogAlert = true;
							_this.alertMsg = "设置成功";
						}else{
							_this.dialogAlert = true;
							_this.alertMsg = data.errmsg;
						}
					},
					error: function() {
						_this.dialogAlert = true;
						_this.alertMsg = '错误，请稍后再试！';
					}
				});
			},
			pageChange:function (page) {
				this.page=page;
				this.loadList()
			},
			pageSizeChange:function (pageSize) {
				this.limit=pageSize
				this.loadList()
			},
			menuselect:function (name) {
				switch(name) {
					case "post":
					this.loadData();
					this.postshow=true;
					this.postlistshow=false;
					this.editendingshow=false;
					break;
					case "postlist":
					this.loadList();
					this.postshow=false;
					this.postlistshow=true;
					this.editendingshow=false;
					break;
					case "editending":
					this.postshow=false;
					this.postlistshow=false;
					this.editendingshow=true;
					break;
				}
			},
			loadList:function () {
				var _this=this
				$.ajax({
					url: "/msgnotification/getmessage",
					type: 'post',
					dataType: "json",
					data: {
						limit:_this.limit,
						page:_this.page,
						name:"",
						date:""
					},
					async: true,
					success: function(data) {
						if(data.success) {
							_this.totalcount=data.total
							_this.tabledata=data.data
						}else{
							_this.dialogAlert = true;
							_this.alertMsg = data.errmsg;
						}
					},
					error: function() {
						_this.dialogAlert = true;
						_this.alertMsg = '错误，请稍后再试！';
					}
				});
			},
			loadData:function () {
				var _this=this
				$.ajax({
					url: "/msgnotification/getuser",
					type: 'post',
					dataType: "json",
					data: {
						rtxaccount:<<<.rtxaccount>>>
					},
					async: true,
					success: function(data) {
						if(data.success) {
							_this.username=data.data[0].Name
							_this.show=false
						}else{
							_this.show=true
						}
					},
					error: function() {
						_this.dialogAlert = true;
						_this.alertMsg = '错误，请稍后再试！';
					}
				});
			},
			
		}
	})

</script>
</html>